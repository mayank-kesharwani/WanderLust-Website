<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wanderlust</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oleo+Script:wght@400;700&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/rating.css" />
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path fill="#fe424d" d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM370.7 389.1L226.4 444.6C207 452.1 187.9 433 195.4 413.6L250.9 269.3C254.2 260.8 260.8 254.2 269.3 250.9L413.6 195.4C433 187.9 452.1 207 444.6 226.4L389.1 370.7C385.8 379.2 379.2 385.8 370.7 389.1zM352 320C352 302.3 337.7 288 320 288C302.3 288 288 302.3 288 320C288 337.7 302.3 352 320 352C337.7 352 352 337.7 352 320z"/></svg>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  </head>
  <body>
    <%- include("../includes/navbar.ejs") %>
    <div class="container">
      <%- include("../includes/flash.ejs") %> <%- body%>
    </div>
    <!-- AI Chatbot UI -->
    <!-- Chatbot Toggle Button -->
    <div id="chatbot-toggle">ðŸ¤–</div>

    <!-- Chatbot Window -->
    <div id="chatbot" class="hidden">
      <div id="chat-header">
        WanderBot ðŸ¤–
        <span id="chat-close">âœ•</span>
      </div>

      <div id="chat-body">
        <p><b>WanderBot:</b> Hi! How can I help you today?</p>
      </div>

      <input id="chat-input" type="text" placeholder="Ask WanderBot..." />
    </div>
    <!--ChatBot End-->
    <%- include("../includes/footer.ejs") %>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const input = document.getElementById("chat-input");
      const body = document.getElementById("chat-body");

      input.addEventListener("keypress", async (e) => {
        if (e.key === "Enter" && input.value.trim()) {
          console.log("Chatbot input fired"); // ðŸ‘ˆ ADD THIS

          const msg = input.value;
          body.innerHTML += `<p><b>You:</b> ${msg}</p>`;
          input.value = "";
          try {
            const res = await fetch("/ai/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: msg }),
            });

            const data = await res.json();
            // STEP-9: Error feedback handling
            if (data.error) {
              body.innerHTML += `
            <p style="color:red">
              <b>Error:</b> ${data.error}
            </p>
          `;
            } else {
              body.innerHTML += `
            <p><b>WanderBot:</b> ${data.reply}</p>
          `;
            }
          } catch (err) {
            body.innerHTML += `
          <p style="color:red">
            <b>Error:</b> Network issue. Please try again.
          </p>
        `;
          }

          body.scrollTop = body.scrollHeight;
        }
      });
    </script>
    <script>
      const toggleBtn = document.getElementById("chatbot-toggle");
      const chatbot = document.getElementById("chatbot");
      const closeBtn = document.getElementById("chat-close");

      toggleBtn.addEventListener("click", () => {
        chatbot.classList.remove("hidden");
        toggleBtn.style.display = "none";
      });

      closeBtn.addEventListener("click", () => {
        chatbot.classList.add("hidden");
        toggleBtn.style.display = "flex";
      });
    </script>
    <script>
      const header = document.getElementById("chat-header");

      let isDragging = false;
      let offsetX = 0;
      let offsetY = 0;

      header.addEventListener("mousedown", startDrag);
      header.addEventListener("touchstart", startDrag);

      function startDrag(e) {
        isDragging = true;
        const rect = chatbot.getBoundingClientRect();

        offsetX = (e.clientX || e.touches[0].clientX) - rect.left;
        offsetY = (e.clientY || e.touches[0].clientY) - rect.top;

        document.addEventListener("mousemove", drag);
        document.addEventListener("touchmove", drag);
        document.addEventListener("mouseup", stopDrag);
        document.addEventListener("touchend", stopDrag);
      }

      function drag(e) {
        if (!isDragging) return;

        chatbot.style.left =
          (e.clientX || e.touches[0].clientX) - offsetX + "px";
        chatbot.style.top =
          (e.clientY || e.touches[0].clientY) - offsetY + "px";

        chatbot.style.bottom = "auto";
        chatbot.style.right = "auto";
      }

      function stopDrag() {
        isDragging = false;
        document.removeEventListener("mousemove", drag);
        document.removeEventListener("touchmove", drag);
        document.removeEventListener("mouseup", stopDrag);
        document.removeEventListener("touchend", stopDrag);
      }
    </script>
    <script src="/js/script.js"></script>
  </body>
</html>
