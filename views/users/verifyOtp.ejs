<% layout("./layouts/boilerplate") -%>

<div class="row justify-content-center">
  <h1 class="col-12 col-md-6 mt-3 text-center">
    Verify Your Email
  </h1>

  <div class="col-12 col-md-6 mt-3">
    <form action="/verify-otp" method="post">

      <input type="hidden" name="email" value="<%= email %>">

      <div class="mb-3">
        <label class="form-label">Enter OTP</label>
        <input
          type="text"
          name="otp"
          class="form-control"
          placeholder="6-digit OTP"
          required
        >
      </div>

      <p id="otp-timer" class="text-muted"></p>

      <button class="btn btn-success w-100 mt-2">
        Verify OTP
      </button>
    </form>

    <button
      type="button"
      id="resendBtn"
      class="btn btn-link w-100 mt-2"
      disabled
    >
      Resend OTP (60s)
    </button>
  </div>
</div>
<script>
  // ⏱ OTP expiry (5 minutes)
  let expiryTime = Date.now() + 5 * 60 * 1000;

  // ⏱ Resend cooldown (60 seconds)
  let resendCooldown = 60;

  const timerEl = document.getElementById("otp-timer");
  const resendBtn = document.getElementById("resendBtn");

  // OTP expiry timer
  setInterval(() => {
    const diff = expiryTime - Date.now();
    if (diff <= 0) {
      timerEl.innerText = "OTP expired. Please resend OTP.";
      return;
    }
    const min = Math.floor(diff / 60000);
    const sec = Math.floor((diff % 60000) / 1000);
    timerEl.innerText = `OTP expires in ${min}:${sec.toString().padStart(2, "0")}`;
  }, 1000);

  // Resend cooldown timer
  let cooldownInterval = setInterval(() => {
    if (resendCooldown <= 0) {
      resendBtn.disabled = false;
      resendBtn.innerText = "Resend OTP";
      clearInterval(cooldownInterval);
      return;
    }
    resendBtn.innerText = `Resend OTP (${resendCooldown--}s)`;
  }, 1000);

  // Resend OTP click
  resendBtn.addEventListener("click", async () => {
    resendBtn.disabled = true;
    resendCooldown = 60;

    const res = await fetch("/resend-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: "<%= email %>" })
    });

    const data = await res.json();
    alert(data.success || data.error);

    cooldownInterval = setInterval(() => {
      if (resendCooldown <= 0) {
        resendBtn.disabled = false;
        resendBtn.innerText = "Resend OTP";
        clearInterval(cooldownInterval);
        return;
      }
      resendBtn.innerText = `Resend OTP (${resendCooldown--}s)`;
    }, 1000);
  });
</script>